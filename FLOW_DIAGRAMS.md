# ğŸ”„ DIAGRAMA DE FLUJO - AUTENTICACIÃ“N Y LOGIN

## Flujo de AutenticaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    USUARIO FRONTEND                         â”‚
â”‚                                                             â”‚
â”‚  Ingresa: email@zahkiel.com / 123456                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ POST /api/auth/login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                                              â”‚
                       â–¼                                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  SERVIDOR BACKEND - PORT 5000    â”‚                â”‚  POSTGRESQL BD      â”‚
        â”‚                                  â”‚                â”‚                     â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                â”‚  TABLE: User        â”‚
        â”‚  â”‚ AuthController.login()     â”‚  â”‚                â”‚  â”œâ”€ id              â”‚
        â”‚  â”‚                            â”‚  â”‚â”€â”€â”€â”€ SELECT â”€â”€â”€â”€â”‚  â”œâ”€ email (unique)   â”‚
        â”‚  â”‚ 1. Parsear email/password  â”‚  â”‚  WHERE email   â”‚  â”œâ”€ passwordHash     â”‚
        â”‚  â”‚ 2. Buscar en BD            â”‚  â”‚                â”‚  â”œâ”€ role            â”‚
        â”‚  â”‚ 3. bcrypt.compare()        â”‚  â”‚                â”‚  â”œâ”€ firstName       â”‚
        â”‚  â”‚ 4. Generar JWT             â”‚  â”‚                â”‚  â””â”€ active          â”‚
        â”‚  â”‚ 5. Devolver tokens         â”‚  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Response con tokens
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  USUARIO FRONTEND RECIBE:        â”‚
        â”‚                                  â”‚
        â”‚  {                               â”‚
        â”‚    token: "eyJh...",             â”‚  â† JWT (1 hora)
        â”‚    refreshToken: "eyJh...",      â”‚  â† Refresh (7 dÃ­as)
        â”‚    user: {                       â”‚
        â”‚      id: "uuid",                 â”‚
        â”‚      role: "admin",              â”‚
        â”‚      firstName: "Admin",         â”‚
        â”‚      lastName: "Zahkiel"         â”‚
        â”‚    }                             â”‚
        â”‚  }                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ Guarda token en localStorage
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  PETICIONES FUTURAS:             â”‚
        â”‚                                  â”‚
        â”‚  Header: Authorization:          â”‚
        â”‚  Bearer {token}                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”œâ”€â”€â”€ GET /api/profile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                                 â”‚
                       â”œâ”€â”€â”€ GET /api/dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       â”‚                                 â”‚
                       â”‚                                 â–¼
                       â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚                    â”‚ authMiddleware.ts    â”‚
                       â”‚                    â”‚                      â”‚
                       â”‚                    â”‚ 1. Extraer token     â”‚
                       â”‚                    â”‚ 2. Verificar JWT     â”‚
                       â”‚                    â”‚ 3. Buscar usuario    â”‚
                       â”‚                    â”‚ 4. Verificar activo  â”‚
                       â”‚                    â”‚ 5. Permitir acceso   â”‚
                       â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚                             â”‚
                       â–¼                             â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              RESPUESTA (Datos del usuario)               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de ActualizaciÃ³n de Token

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Token prÃ³ximo a expirar (1 hora)       â”‚
â”‚  Pero refreshToken aÃºn vÃ¡lido (7 dÃ­as)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”œâ”€ POST /api/auth/refresh
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  AuthController.refresh()        â”‚
        â”‚                                  â”‚
        â”‚  1. Verificar refreshToken       â”‚
        â”‚  2. Buscar usuario               â”‚
        â”‚  3. Generar nuevo JWT            â”‚
        â”‚  4. Devolver nuevo token         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  { token: "nuevo_jwt" }          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Actualizar localStorage         â”‚
        â”‚  Usar nuevo token en peticiones  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo de ValidaciÃ³n de Credenciales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario: admin@zahkiel.com                             â”‚
â”‚  ContraseÃ±a: 123456                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Validar formato (Zod)              â”‚
        â”‚  â”œâ”€ Email vÃ¡lido âœ“                  â”‚
        â”‚  â”œâ”€ Password >= 6 caracteres âœ“      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Buscar usuario en BD                â”‚
        â”‚  SELECT * FROM User                  â”‚
        â”‚  WHERE email = 'admin@zahkiel.com'   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
              â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Â¿Encontrado?â”‚           â”‚ No existe  â”‚
        â”‚    SÃ      â”‚           â”‚ âŒ Error   â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Verificar si estÃ¡ activo            â”‚
        â”‚  user.active = true âœ“                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ SÃ â”€â”€â”    â”œâ”€ NO â”€â”€â”
              â”‚       â”‚    â”‚       â”‚
              â–¼       â–¼    â–¼       â–¼
        [Continuar]  [âŒ Error - Usuario inactivo]
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  bcrypt.compare()                    â”‚
        â”‚  ContraseÃ±a actual vs passwordHash   â”‚
        â”‚                                      â”‚
        â”‚  'test123' vs                        â”‚
        â”‚  '$2a$10$N9qo8uLOi...'               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ COINCIDE â”€â”€â”     â”œâ”€ NO COINCIDE â”€â”€â”
              â”‚             â”‚     â”‚                â”‚
              â–¼             â–¼     â–¼                â–¼
        [Continuar]      [âŒ Error - ContraseÃ±a invÃ¡lida]
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Generar JWT                         â”‚
        â”‚  jwt.sign({userId, role},            â”‚
        â”‚    JWT_SECRET,                       â”‚
        â”‚    {expiresIn: '1h'})                â”‚
        â”‚                                      â”‚
        â”‚  Resultado:                          â”‚
        â”‚  eyJhbGciOiJIUzI1NiIsInR5cCI...      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Generar Refresh Token               â”‚
        â”‚  jwt.sign({userId},                  â”‚
        â”‚    JWT_REFRESH_SECRET,               â”‚
        â”‚    {expiresIn: '7d'})                â”‚
        â”‚                                      â”‚
        â”‚  Resultado:                          â”‚
        â”‚  eyJhbGciOiJIUzI1NiIsInR5cCI...      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Enviar respuesta al cliente         â”‚
        â”‚  {                                   â”‚
        â”‚    token: "...",                     â”‚
        â”‚    refreshToken: "...",              â”‚
        â”‚    user: {id, role, firstName, ...}  â”‚
        â”‚  }                                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        âœ… LOGIN EXITOSO
```

---

## Flujo de ProtecciÃ³n de Rutas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cliente hace request a ruta protegida  â”‚
â”‚  GET /api/profile                       â”‚
â”‚                                         â”‚
â”‚  Header: Authorization: Bearer {token}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  authMiddleware.ts                   â”‚
        â”‚                                      â”‚
        â”‚  1. Extraer token de header          â”‚
        â”‚     Authorization: Bearer {token}    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                 â”‚
              â–¼                                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚Â¿Token      â”‚                    â”‚ Sin token  â”‚
        â”‚presente?   â”‚                    â”‚ âŒ 401     â”‚
        â”‚    SÃ      â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. Verificar JWT                    â”‚
        â”‚  jwt.verify(token, JWT_SECRET)       â”‚
        â”‚  Decodificar y validar firma         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ VÃLIDO â”€â”€â”    â”œâ”€ INVÃLIDO â”€â”€â”
              â”‚           â”‚    â”‚             â”‚
              â–¼           â–¼    â–¼             â–¼
        [Continuar]      [âŒ 401 - Token invÃ¡lido]
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  3. Buscar usuario en BD             â”‚
        â”‚  const user = await prisma.user...   â”‚
        â”‚  WHERE id = decoded.userId           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ ENCONTRADO â”€â”€â”    â”œâ”€ NO EXISTE â”€â”€â”
              â”‚               â”‚    â”‚              â”‚
              â–¼               â–¼    â–¼              â–¼
        [Continuar]      [âŒ 401 - Usuario no existe]
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  4. Verificar si estÃ¡ activo         â”‚
        â”‚  user.active = true                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â”œâ”€ ACTIVO â”€â”€â”    â”œâ”€ INACTIVO â”€â”€â”
              â”‚           â”‚    â”‚             â”‚
              â–¼           â–¼    â–¼             â–¼
        [Continuar]      [âŒ 401 - Usuario inactivo]
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5. Agregar usuario a req            â”‚
        â”‚  req.user = {                        â”‚
        â”‚    id: user.id,                      â”‚
        â”‚    role: user.role                   â”‚
        â”‚  }                                   â”‚
        â”‚  next()                              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  6. Ejecutar controlador de ruta     â”‚
        â”‚  GET /api/profile                    â”‚
        â”‚  res.json({ user: req.user })        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  7. Enviar respuesta                 â”‚
        â”‚  {                                   â”‚
        â”‚    id: "550e8400...",                â”‚
        â”‚    role: "admin",                    â”‚
        â”‚    firstName: "Admin",               â”‚
        â”‚    lastName: "Zahkiel"               â”‚
        â”‚  }                                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
        âœ… ACCESO PERMITIDO
```

---

## Componentes Clave

### 1. **bcryptjs** - EncriptaciÃ³n de contraseÃ±as
```
ContraseÃ±a ingresada: "123456"
         â”‚
         â–¼
    bcrypt.hash() â”€â”€â”€â”€â”€â”€â”€â”€â–º $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcg7b3XeKeUxWdeS86E36gZvWFm
         â”‚
         â–¼
    Almacenada en BD

VerificaciÃ³n:
ContraseÃ±a ingresada: "123456"
         â”‚
         â–¼
    bcrypt.compare(ingresada, hashDB) â”€â”€â”€â”€â–º true/false
```

### 2. **JWT** - Tokens seguros
```
Payload: { userId: "550e8400...", role: "admin" }
         â”‚
         â–¼
    jwt.sign(payload, SECRET, {expiresIn: '1h'})
         â”‚
         â–¼
    eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.
    eyJ1c2VySWQiOiI1NTBlODQwMC4uLiIsInJvbGUiOiJhZG1pbiIsImV4cCI6MTYzODM2MDAwMH0.
    Z-5I-Y2J_Gy6cQR3n1V_ZX1J_K2L_M3N_O4P_Q5R
         â”‚
         â–¼
    Enviado al cliente en Authorization header
```

### 3. **Prisma** - ORM para acceder a BD
```
await prisma.user.findUnique({
  where: { email: 'admin@zahkiel.com' },
  select: { id, passwordHash, role, active }
})
         â”‚
         â–¼
    Ejecuta SQL automÃ¡ticamente en PostgreSQL
         â”‚
         â–¼
    Retorna objeto JavaScript
```

---

## Tabla de Decisiones

| SituaciÃ³n | AcciÃ³n | CÃ³digo HTTP |
|-----------|--------|-------------|
| Email no vÃ¡lido | Rechazar | 400 |
| Usuario no existe | Rechazar | 401 |
| Usuario inactivo | Rechazar | 401 |
| ContraseÃ±a incorrecta | Rechazar | 401 |
| Token ausente | Rechazar | 401 |
| Token invÃ¡lido/expirado | Rechazar | 401 |
| Acceso sin autorizaciÃ³n | Rechazar | 403 |
| Login exitoso | Aceptar + tokens | 200 |
| Acceso permitido | Aceptar | 200 |

---

**Estado**: âœ… Documentado y listo
**Ãšltima actualizaciÃ³n**: Febrero 2026
